export CC=@CC@
export CFLAGS=@CFLAGS@
export SONAME=@SONAME@
export SOEXT=@SOEXT@
export prefix=@prefix@
export exec_prefix=@exec_prefix@
export LIBDIR=@libdir@
export INSTALL_OPTIONS=@INSTALL_OPTIONS@
export PLATFORM=@PLATFORM@
export BUILD_MAGIC=@BUILD_MAGIC@
export BUILD_FUZZY=@BUILD_FUZZY@

BUILD_C_LIBS=@BUILD_C_LIBS@
PYTHON=@PYTHON@
SRC_C_DIR="./src/C"
ifeq ($(strip $(prefix)),)
	PREFIX=""
else
	PREFIX="--prefix=$(prefix)"
endif
START_SCRIPT="binwalk-start"

.PHONY: all install build deps clean uninstall

all: build

install: build
	if [ "$(BUILD_C_LIBS)" -eq "1" ]; then make -C $(SRC_C_DIR) install; fi
	$(PYTHON) ./setup.py install $(PREFIX)
	if [ "$(BUILD_C_LIBS)" -eq "1" ] && [ $(findstring "CYGWIN", $(PLATFORM)) ]; then ldconfig || true; fi

build:
	if [ "$(BUILD_C_LIBS)" -eq "1" ]; then make -C $(SRC_C_DIR); fi
	echo "$(prefix)" > src/binwalk/config/prefix.conf
	$(PYTHON) ./setup.py build

start-script:
	echo '#!/bin/sh' > $(START_SCRIPT)
	echo "PREFIX=\"$(prefix)\"" >> $(START_SCRIPT)
	echo 'PYVERSION=`python --version 2>&1 | cut -d' ' -f2 | cut -d'.' -f1,2`' >> $(START_SCRIPT)
	echo 'export PYTHONPATH="\$PREFIX/lib/python$PYVERSION/site-packages"' >> $(START_SCRIPT)
	echo '\$PREFIX/bin/binwalk "\$@"' >> $(START_SCRIPT)
	chmod +x $(START_SCRIPT)


clean:
	if [ "$(BUILD_C_LIBS)" -eq "1" ]; then make -C $(SRC_C_DIR) clean; fi
	$(PYTHON) ./setup.py clean

distclean: clean
	if [ "$(BUILD_C_LIBS)" -eq "1" ]; then make -C $(SRC_C_DIR) distclean; fi
	rm -rf Makefile config.* *.cache $(START_SCRIPT)

uninstall:
	if [ "$(BUILD_C_LIBS)" -eq "1" ]; then make -C $(SRC_C_DIR) uninstall; fi
	$(PYTHON) ./setup.py uninstall

